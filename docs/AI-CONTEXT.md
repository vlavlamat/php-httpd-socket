Ниже — предлагаемый файл контекста для нового проекта (Unix-socket вместо TCP). Сохрани его, например, как docs/AI-CONTEXT.md в новом репозитории.

AI-CONTEXT — руководящие принципы для AI Assistant и Junie (проект PHP-FPM + Apache через Unix-socket)

1) Назначение документа
- Зафиксировать цели и рамки проекта.
- Синхронизировать подходы AI Assistant и Junie, чтобы не сбиваться с курса.
- Служить источником правды при принятии технических решений в процессе миграции с TCP:9000 на Unix-socket.

2) Цель проекта
- На базе предыдущего учебного стека перейти с проксирования Apache→PHP-FPM по TCP:9000 на взаимодействие через Unix-socket.
- Сохранить весь функционал и UX: PHP-FPM 8.4, Apache 2.4, MySQL 8.4, phpMyAdmin, удобный Makefile, Xdebug-оверлей, healthchecks, обучательная направленность.

3) Итоговая архитектура (целевое состояние)
- PHP-FPM:
    - Выполняет PHP.
    - Слушает Unix-socket (не порт).
    - Путь сокета: общий для Apache и PHP-FPM, расположен в общем томе.
- Apache:
    - Отдаёт статику.
    - Проксирует .php в PHP-FPM через Unix-socket (mod_proxy_fcgi).
- MySQL и phpMyAdmin:
    - Без изменений по сути; остаются как в исходном проекте.
- Внешние порты:
    - Apache: 80 → localhost:80.
    - phpMyAdmin: 80 контейнера → localhost:8080.
    - MySQL: 3306 → localhost:3306.

4) Ключевые решения и ограничения
- Соединение Apache ↔ PHP-FPM: строго через Unix-socket.
- Для Unix-socket нужен общий volume, смонтированный в оба контейнера (Apache и PHP-FPM).
- Не использовать сетевой TCP-порт 9000 для PHP-FPM.
- Сохранить удобство для обучения: «говорящие» конфиги, Makefile, примеры.
- Производительность/безопасность на уровне dev; проект не для продакшена.

5) Правила для AI Assistant и Junie
- Язык общения и конфигурационной документации: русский.
- Бэкенд-стек: PHP 8.4 (FPM), Apache 2.4, MySQL 8.4, phpMyAdmin, Docker Compose v2+.
- Не менять смысловую структуру проекта без отдельного обсуждения.
- Предпочитать минимальные, точечные изменения, с чёткими комментариями и контекстом.
- Если есть несколько вариантов решения — предлагать 1–2 оптимальных, кратко аргументируя.
- Для правок кода/конфигов всегда указывать краткий контекст и комментарии «// ... existing code ...» согласно принятому формату.
- Не упоминать содержимое вложений/аттачей без необходимости.
- Не превращать проект в продовый: без усложнения CI/CD, секьюрити-политик уровня enterprise и т.д.

6) Именование и структура нового репозитория
- Имя репозитория (предложение): php-apache-socket.
- Базовая структура (аналог исходной, с адаптациями):
    - config/
        - apache/httpd.conf (обновлён под Unix-socket)
        - php/php.ini (возможны минимальные правки, если потребуется для сокета/прав)
    - docker/
        - php.Dockerfile (как база для php-fpm, без публикации порта 9000)
    - env/
        - .env.example (без изменений по смыслу; переменные Xdebug, MySQL и т.д.)
    - public/ (DocumentRoot)
    - docker-compose.yml (замена TCP на Unix-socket; общий том под сокет)
    - docker-compose.xdebug.yml (оверлей для Xdebug; совместим с сокетом)
    - Makefile (команды управления стеком)
    - README.md (обновлённые инструкции под Unix-socket)
    - docs/AI-CONTEXT.md (этот файл)

7) План миграции с TCP на Unix-socket (пошагово)
- Шаг 1: Создать новый репозиторий на базе старого (без функциональных изменений).
- Шаг 2: Добавить общий том для Unix-socket, например:
    - Имя: php-fpm-sock.
    - Точка монтирования в обоих контейнерах: /var/run/php.
- Шаг 3: Настроить PHP-FPM:
    - listen = /var/run/php/php-fpm.sock
    - Настроить права сокета: listen.owner, listen.group (обычно www-data) и listen.mode (например, 660).
    - Убедиться, что директория /var/run/php существует и доступна для записи php-fpm.
- Шаг 4: Настроить Apache (mod_proxy_fcgi):
    - Проксирование .php на Unix-socket.
    - Важно: путь к сокету внутри контейнера Apache должен совпадать с путём, который пишет PHP-FPM, через общий том.
    - Убедиться, что User/Group Apache совместимы с правами на сокет.
- Шаг 5: Обновить healthchecks:
    - PHP-FPM: использовать cgi-fcgi -connect /var/run/php/php-fpm.sock (без localhost:9000).
    - Apache/MySQL/phpMyAdmin: без изменений, кроме зависимостей.
- Шаг 6: Проверить depends_on:
    - Apache должен ждать здоровый PHP-FPM.
- Шаг 7: Запуск и проверка:
    - make up → http://localhost, phpinfo, тест .php.
    - Проверить логи и здоровье контейнеров.
- Шаг 8: README.md:
    - Обновить разделы про архитектуру и healthchecks.
    - Добавить примечания по правам на сокет и общему тому.
- Шаг 9: Xdebug:
    - Убедиться, что Xdebug по-прежнему подключается (порт 9003 для IDE).
    - Транспорт Xdebug не влияет на Apache↔FPM сокет.

8) Требования к конфигурации PHP-FPM (целевое)
- listen: /var/run/php/php-fpm.sock
- listen.owner / listen.group: согласовать с пользователем/группой Apache (обычно www-data или apache, зависит от образа).
- listen.mode: 660 (или 666 для упрощения в учебных целях, но по умолчанию — 660).
- Директория сокета (/var/run/php) должна существовать; создать в Dockerfile или через entrypoint/command.
- Не публиковать порт 9000 (EXPOSE можно оставить как метку, но наружу порт не пробрасывать; проксирование по сокету).

9) Требования к конфигурации Apache (целевое)
- Включён mod_proxy_fcgi.
- ProxyPassMatch (или SetHandler/FilesMatch) направляет .php на Unix-socket.
- Пример логики (без конкретного кода): .php → unix:/var/run/php/php-fpm.sock с правильным fcgi://backend/DocumentRoot.
- DocumentRoot и SCRIPT_FILENAME корректно соответствуют пути в контейнере Apache (обычно /var/www/html).
- Убедиться, что Apache-процессы могут читать/исполнять PHP-файлы и иметь доступ к сокету (права/группа, общий том).

10) Общие тома и права
- Общий том для сокета:
    - volumes:
        - php-fpm-sock:/var/run/php (оба контейнера)
- Права:
    - Совместить user/group Apache и PHP-FPM (или использовать слушающий режим 666 для простоты в учебном проекте).
    - Альтернатива: использовать одинаковую группу и задать listen.mode=660.

11) Healthchecks (целевое)
- PHP-FPM: cgi-fcgi -bind -connect /var/run/php/php-fpm.sock
- Apache: HTTP-запрос к http://localhost/
- MySQL: mysqladmin ping
- phpMyAdmin: HTTP-запрос к http://localhost/
- depends_on: Apache ждёт healthy PHP-FPM.

12) Makefile и команды
- Сохранить существующую семантику: setup, up, down, restart, logs, status.
- Сохранить xdebug-up / xdebug-down (оверлей). Оверлей не меняет способ проксирования, только включает Xdebug.

13) Xdebug (заметки)
- Версия Xdebug 3; порт клиента IDE — 9003.
- Настройки XDEBUG_MODE / XDEBUG_START — через .env или оверлей.
- Подключение Xdebug не зависит от способа связи Apache↔FPM (сокет vs TCP).

14) Тестирование и критерии приёмки
- Открывается http://localhost, статика и .php отдаются.
- phpinfo() показывает fpm и xdebug (если включён).
- Локи ошибок Apache/PHP-FPM без критических ошибок прав на сокет.
- Healthchecks всех четырёх сервисов OK.
- phpMyAdmin доступен на http://localhost:8080 и подключается к MySQL.
- В public/ изменения видны сразу.

15) Не-цели
- Продакшен-хардненинг, SSL/TLS, сложные балансировщики.
- Мультихостовая оркестрация (Swarm/Kubernetes).
- Оптимизация производительности под нагрузку.

16) Безопасность (в рамках учебного проекта)
- Не хранить реальные секреты в репозитории.
- .env — локально, .env.example — шаблон без секретов.
- Порты открыты только локально; проект не для удалённой публикации.
- Права на сокет — минимально необходимые для работы Apache.

17) Коммуникация и процесс изменений
- Любые изменения конфигурации сопровождаются кратким описанием «зачем» и «что именно».
- В PR/коммитах — краткий список затронутых файлов и последствий.
- AI-ответы должны быть лаконичными, с фокусом на конкретных правках/шаговках.

18) Версионирование и совместимость
- PHP 8.4, Apache 2.4, MySQL 8.4 — ориентиры по образам.
- Docker Compose v2+.
- По возможности использовать alpine-образы, держать образы компактными.
- Слежение за совместимостью mod_proxy_fcgi и путей к сокету.

19) Потенциальные риски и их обработка
- Права на сокет: решить через согласование пользователя/группы или через права 666 (в учебных целях).
- Неверная конфигурация ProxyPassMatch/SetHandler: сверить пути DocumentRoot и SCRIPT_FILENAME.
- Несоответствие путей при монтировании общего тома: единый путь /var/run/php в обоих контейнерах.

20) Что подготовить перед реализацией правок
- Подтвердить целевой путь к сокету: /var/run/php/php-fpm.sock.
- Определить пользователя/группу Apache (в образе httpd:2.4-alpine это обычно daemon) и согласовать с FPM.
- Решить, используем ли фиксированного пользователя www-data в php-fpm и группу, общую с Apache, либо временно ставим listen.mode=666.

Конец документа.